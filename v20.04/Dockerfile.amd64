FROM owncloud/base:20.04-amd64@sha256:0f0d90e8f85a4a6d672da4189811b1a789ad0fe66ae0135493beabba89eb9f61

LABEL maintainer="ownCloud GmbH <devops@owncloud.com>" \
  org.opencontainers.image.authors="ownCloud DevOps <devops@owncloud.com>" \
  org.opencontainers.image.title="ownCloud Univention Appliance" \
  org.opencontainers.image.url="https://hub.docker.com/r/owncloud/appliance" \
  org.opencontainers.image.source="https://github.com/owncloud-docker/appliance" \
  org.opencontainers.image.documentation="https://github.com/owncloud-docker/appliance"

VOLUME ["/mnt/data"]
EXPOSE 8080

ENTRYPOINT ["/usr/bin/entrypoint"]
CMD ["/usr/bin/owncloud", "server"]

RUN apt-get update -y && \
  apt-get upgrade -y && \
  apt-get clean && \
  rm -rf /var/lib/apt/lists/*

ADD owncloud.tar.bz2 /var/www/
ADD user_ldap.tar.gz /var/www/owncloud/apps/
ADD richdocuments.tar.gz /var/www/owncloud/apps/
ADD onlyoffice.tar.gz /var/www/owncloud/apps/
ADD openidconnect.tar.gz /var/www/owncloud/apps/

COPY ./overlay /
WORKDIR /var/www/owncloud

RUN find /var/www/owncloud \( \! -user www-data -o \! -group root \) -print0 | xargs -r -0 chown www-data:root && \
  chmod g+w /var/www/owncloud
